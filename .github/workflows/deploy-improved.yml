# Deploy Hugo Blog (Improved Version with Cloudflare Cache Purge)
# ê°œì„  ì‚¬í•­:
# 1. Cloudflare Cache ìë™ Purge (â˜… ê°€ì¥ ì¤‘ìš”!)
# 2. Pull Request ë¹Œë“œ í…ŒìŠ¤íŠ¸
# 3. Hugo ìºì‹œ ì¶”ê°€ (ë¹Œë“œ ì†ë„ ê°œì„ )
# 4. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±

name: Deploy Hugo Blog (improved)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"
  pull_request:  # PRì—ì„œë„ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: hugo-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: PR ë¹Œë“œ í…ŒìŠ¤íŠ¸ (main ë°°í¬ ì „ ê²€ì¦)
  # ============================================
  test:
    if: github.event_name == 'pull_request'
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build Test
        run: |
          echo "ğŸ§ª PR ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¤‘..."
          hugo --minify

          echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼:"
          echo "  HTML files: $(find public -name '*.html' | wc -l)"
          echo "  Total size: $(du -sh public | cut -f1)"

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼! ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
            })

  # ============================================
  # Job 2: Main ë¸Œëœì¹˜ ë°°í¬
  # ============================================
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      # ============================================
      # Hugo ë¦¬ì†ŒìŠ¤ ìºì‹œ (ë¹Œë“œ ì†ë„ ê°œì„ )
      # ============================================
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources/_gen
            .hugo_build.lock
          key: ${{ runner.os }}-hugo-${{ hashFiles('config.toml') }}
          restore-keys: |
            ${{ runner.os }}-hugo-

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
          PRIVATE_TOTP_SECRET: ${{ secrets.PRIVATE_TOTP_SECRET }}
          PRIVATE_AES_KEY: ${{ secrets.PRIVATE_AES_KEY }}
        run: |
          set -euxo pipefail

          echo "ğŸ”¨ Hugo ë¹Œë“œ ì‹œì‘..."
          START_TIME=$SECONDS

          hugo --minify

          BUILD_TIME=$((SECONDS - START_TIME))
          echo "âœ… ë¹Œë“œ ì™„ë£Œ (${BUILD_TIME}ì´ˆ)"
          echo "ğŸ“Š html_count=$(find public -name '*.html' | wc -l)"

      - name: Encrypt private content
        env:
          PRIVATE_AES_KEY: ${{ secrets.PRIVATE_AES_KEY }}
        run: |
          if [ -d "public/private" ]; then
            echo "ğŸ” Encrypting private content..."
            ./scripts/encrypt-private-content.sh
          else
            echo "â„¹ï¸ No private content to encrypt"
          fi

      - name: Stamp deploy info
        run: |
          printf "source=ci\ntime=%s\ncommit=%s\nrun_id=%s\n" \
            "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "${GITHUB_SHA::7}" "$GITHUB_RUN_ID" \
            > public/deploy.txt

      # ============================================
      # í˜„ì¬ ë²„ì „ ë°±ì—… (ë¡¤ë°±ìš©)
      # ============================================
      - name: Backup current version
        id: backup
        run: |
          if [ -d /var/www/blog ]; then
            BACKUP_DIR="/var/www/blog.backup.$(date +%s)"
            sudo cp -r /var/www/blog "$BACKUP_DIR"
            echo "backup_dir=$BACKUP_DIR" >> $GITHUB_OUTPUT
            echo "âœ… Backup created: $BACKUP_DIR"
          fi

      # ============================================
      # ë°°í¬
      # ============================================
      - name: Deploy to nginx root
        id: deploy
        run: |
          set -euxo pipefail

          echo "ğŸš€ ë°°í¬ ì‹œì‘..."
          sudo mkdir -p /var/www/blog

          sudo rsync -avh --delete public/ /var/www/blog/

          sudo chown -R www-data:www-data /var/www/blog
          sudo chmod -R 755 /var/www/blog
          sudo find /var/www/blog -type f -exec chmod 644 {} \;

          sudo nginx -t
          sudo systemctl reload nginx

          echo "âœ… ë°°í¬ ì™„ë£Œ"

      # ============================================
      # Cloudflare Cache Purge (â˜… í•µì‹¬!)
      # ============================================
      - name: Purge Cloudflare Cache
        if: success()
        env:
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ”¥ Cloudflare ìºì‹œ ì‚­ì œ ì¤‘..."

          if [ -z "$CF_ZONE_ID" ] || [ -z "$CF_TOKEN" ]; then
            echo "âš ï¸  Cloudflare secrets not set. Skipping cache purge."
            echo "   Set CLOUDFLARE_ZONE_ID and CLOUDFLARE_API_TOKEN in GitHub Secrets"
            exit 0
          fi

          RESPONSE=$(curl -X POST \
            "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            -s -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            SUCCESS=$(echo $BODY | jq -r '.success')
            if [ "$SUCCESS" = "true" ]; then
              echo "âœ… Cloudflare ìºì‹œ ì‚­ì œ ì™„ë£Œ!"
            else
              echo "âš ï¸  Cloudflare API returned success=false"
              echo $BODY | jq
            fi
          else
            echo "âŒ Failed to purge cache (HTTP $HTTP_CODE)"
            echo $BODY | jq || echo $BODY
            # ìºì‹œ ì‚­ì œ ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ì¤‘ìš”í•˜ì§€ë§Œ ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ)
          fi

      # ============================================
      # ë°°í¬ ê²€ì¦
      # ============================================
      - name: Post-deployment Verification
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."

          # 1. í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          for file in index.html 404.html deploy.txt; do
            if [ -f "/var/www/blog/$file" ]; then
              echo "âœ… $file exists ($(wc -c < /var/www/blog/$file) bytes)"
            else
              echo "âŒ $file NOT found"
              exit 1
            fi
          done

          # 2. ë¡œì»¬ ì ‘ì† í…ŒìŠ¤íŠ¸
          echo "ğŸŒ ë¡œì»¬ HTTP í…ŒìŠ¤íŠ¸..."
          if curl -sf http://localhost/ > /dev/null; then
            echo "âœ… ë¡œì»¬ HTTP ì ‘ì† ì„±ê³µ"
          else
            echo "âŒ ë¡œì»¬ HTTP ì ‘ì† ì‹¤íŒ¨"
            exit 1
          fi

          # 3. ì‹¤ì œ ë„ë©”ì¸ ì ‘ì† í…ŒìŠ¤íŠ¸
          sleep 2
          echo "ğŸŒ ì‹¤ì œ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸..."
          if curl -sf https://blog.jiminhome.shop/ > /dev/null; then
            echo "âœ… ì‹¤ì œ ë„ë©”ì¸ ì ‘ì† ì„±ê³µ"
          else
            echo "âŒ ì‹¤ì œ ë„ë©”ì¸ ì ‘ì† ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼!"

      # ============================================
      # ë¡¤ë°± (ë°°í¬ ì‹¤íŒ¨ ì‹œ)
      # ============================================
      - name: Rollback on failure
        if: failure() && steps.backup.outputs.backup_dir != ''
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±..."

          BACKUP_DIR="${{ steps.backup.outputs.backup_dir }}"

          if [ -d "$BACKUP_DIR" ]; then
            sudo rm -rf /var/www/blog
            sudo cp -r "$BACKUP_DIR" /var/www/blog
            sudo systemctl reload nginx
            echo "âœ… ë¡¤ë°± ì™„ë£Œ: $BACKUP_DIR"
          else
            echo "âŒ ë°±ì—… ë””ë ‰í† ë¦¬ ì—†ìŒ: $BACKUP_DIR"
          fi

      # ============================================
      # ë°±ì—… ì •ë¦¬ (ì„±ê³µ ì‹œ ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ)
      # ============================================
      - name: Cleanup old backups
        if: success()
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ ì¤‘..."

          # ìµœê·¼ 3ê°œ ë°±ì—…ë§Œ ìœ ì§€
          sudo find /var/www -maxdepth 1 -type d -name "blog.backup.*" \
            | sort -r \
            | tail -n +4 \
            | xargs -r sudo rm -rf

          echo "âœ… ë°±ì—… ì •ë¦¬ ì™„ë£Œ"
