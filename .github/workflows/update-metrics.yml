name: Update Homepage Metrics

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (KST 09:00) ìë™ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-metrics:
    runs-on: self-hosted  # í™ˆì„œë²„ì—ì„œ ì‹¤í–‰ (kubectl ì ‘ê·¼ ê°€ëŠ¥)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate uptime days
        id: uptime
        run: |
          START_DATE="2024-11-27"
          CURRENT_DATE=$(date +%s)
          START_TIMESTAMP=$(date -d "$START_DATE" +%s)
          DAYS=$(( ($CURRENT_DATE - $START_TIMESTAMP) / 86400 ))
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "ğŸ“… ìš´ì˜ ì¼ìˆ˜: $DAYSì¼"

      - name: Get cluster metrics
        id: cluster
        run: |
          # Pod ê°œìˆ˜
          TOTAL_PODS=$(kubectl get pods --all-namespaces --no-headers | wc -l)
          echo "pods=$TOTAL_PODS" >> $GITHUB_OUTPUT
          echo "ğŸš€ ì „ì²´ Pod: $TOTAL_PODSê°œ"

          # ë…¸ë“œ ê°œìˆ˜
          TOTAL_NODES=$(kubectl get nodes --no-headers | wc -l)
          echo "nodes=$TOTAL_NODES" >> $GITHUB_OUTPUT
          echo "ğŸ–¥ï¸  ë…¸ë“œ: $TOTAL_NODESê°œ"

          # blog-system Pod ê°œìˆ˜
          BLOG_PODS=$(kubectl get pods -n blog-system --no-headers | grep Running | wc -l)
          echo "blog_pods=$BLOG_PODS" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ blog-system Pod: $BLOG_PODSê°œ"

      - name: Update config.toml
        run: |
          UPTIME_DAYS=${{ steps.uptime.outputs.days }}
          TOTAL_PODS=${{ steps.cluster.outputs.pods }}
          TOTAL_NODES=${{ steps.cluster.outputs.nodes }}

          # ìš´ì˜ ì¼ìˆ˜ ì—…ë°ì´íŠ¸
          sed -i "s/data-count='[0-9]*' data-suffix='ì¼'/data-count='$UPTIME_DAYS' data-suffix='ì¼'/g" config.toml

          # Pod ê°œìˆ˜ ì—…ë°ì´íŠ¸
          sed -i "s/data-count='[0-9]*' data-suffix='ê°œ Pod'/data-count='$TOTAL_PODS' data-suffix='ê°œ Pod'/g" config.toml

          # ë…¸ë“œ ì •ë³´ ì—…ë°ì´íŠ¸ (4ë…¸ë“œ ë¶€ë¶„)
          sed -i "s/ê·œëª¨: [0-9]ë…¸ë“œ/ê·œëª¨: ${TOTAL_NODES}ë…¸ë“œ/g" config.toml
          sed -i "s/ë² ì–´ë©”íƒˆ K8s í´ëŸ¬ìŠ¤í„° ì§ì ‘ êµ¬ì¶• ([0-9]ë…¸ë“œ/ë² ì–´ë©”íƒˆ K8s í´ëŸ¬ìŠ¤í„° ì§ì ‘ êµ¬ì¶• (${TOTAL_NODES}ë…¸ë“œ/g" config.toml

          echo "âœ… config.toml ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: Check if changes exist
        id: check_changes
        run: |
          if git diff --quiet config.toml; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœ)"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
            git diff config.toml
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add config.toml
          git commit -m "chore: Auto-update homepage metrics

ìš´ì˜ ì¼ìˆ˜: ${{ steps.uptime.outputs.days }}ì¼
ì „ì²´ Pod: ${{ steps.cluster.outputs.pods }}ê°œ
ë…¸ë“œ: ${{ steps.cluster.outputs.nodes }}ê°œ

Co-Authored-By: GitHub Actions Bot <github-actions[bot]@users.noreply.github.com>"

          git push origin main

          echo "ğŸš€ ìë™ ë°°í¬ íŠ¸ë¦¬ê±°ë¨ (deploy-web.yml ì‹¤í–‰ ì˜ˆì •)"

      - name: Summary
        run: |
          echo "### ğŸ“Š ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ìš´ì˜ ì¼ìˆ˜**: ${{ steps.uptime.outputs.days }}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ì „ì²´ Pod**: ${{ steps.cluster.outputs.pods }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë…¸ë“œ**: ${{ steps.cluster.outputs.nodes }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **blog-system Pod**: ${{ steps.cluster.outputs.blog_pods }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… config.toml ìë™ ì—…ë°ì´íŠ¸ ë° ë°°í¬ íŠ¸ë¦¬ê±°" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœ)" >> $GITHUB_STEP_SUMMARY
          fi
