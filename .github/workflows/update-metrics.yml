name: Update Homepage Metrics

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (KST 09:00) ìë™ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-metrics:
    runs-on: self-hosted  # í™ˆì„œë²„ì—ì„œ ì‹¤í–‰ (kubectl ì ‘ê·¼ ê°€ëŠ¥)
    permissions:
      contents: write  # Git push ê¶Œí•œ í•„ìš”

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate uptime days
        id: uptime
        run: |
          START_DATE="2024-11-27"
          CURRENT_DATE=$(date +%s)
          START_TIMESTAMP=$(date -d "$START_DATE" +%s)
          DAYS=$(( ($CURRENT_DATE - $START_TIMESTAMP) / 86400 ))
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "ğŸ“… ìš´ì˜ ì¼ìˆ˜: $DAYSì¼"

      - name: Get cluster metrics
        id: cluster
        run: |
          # Pod ê°œìˆ˜
          TOTAL_PODS=$(kubectl get pods --all-namespaces --no-headers | wc -l)
          echo "pods=$TOTAL_PODS" >> $GITHUB_OUTPUT
          echo "ğŸš€ ì „ì²´ Pod: $TOTAL_PODSê°œ"

          # ë…¸ë“œ ê°œìˆ˜
          TOTAL_NODES=$(kubectl get nodes --no-headers | wc -l)
          echo "nodes=$TOTAL_NODES" >> $GITHUB_OUTPUT
          echo "ğŸ–¥ï¸  ë…¸ë“œ: $TOTAL_NODESê°œ"

          # blog-system Pod ê°œìˆ˜
          BLOG_PODS=$(kubectl get pods -n blog-system --no-headers | grep Running | wc -l)
          echo "blog_pods=$BLOG_PODS" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ blog-system Pod: $BLOG_PODSê°œ"

      - name: Update metrics.yaml
        run: |
          UPTIME_DAYS=${{ steps.uptime.outputs.days }}
          TOTAL_PODS=${{ steps.cluster.outputs.pods }}
          TOTAL_NODES=${{ steps.cluster.outputs.nodes }}
          BLOG_PODS=${{ steps.cluster.outputs.blog_pods }}
          CURRENT_TIME=$(date -Iseconds)

          # yqë¡œ YAML ì—…ë°ì´íŠ¸
          yq eval ".homelab.uptime_days = $UPTIME_DAYS" -i data/metrics.yaml
          yq eval ".homelab.total_pods = $TOTAL_PODS" -i data/metrics.yaml
          yq eval ".homelab.total_nodes = $TOTAL_NODES" -i data/metrics.yaml
          yq eval ".homelab.blog_pods = $BLOG_PODS" -i data/metrics.yaml
          yq eval ".homelab.updated_at = \"$CURRENT_TIME\"" -i data/metrics.yaml

          echo "âœ… data/metrics.yaml ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          cat data/metrics.yaml

      - name: Check if changes exist
        id: check_changes
        run: |
          if git diff --quiet data/metrics.yaml; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœ)"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
            git diff data/metrics.yaml
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/metrics.yaml
          git commit -m "chore: Auto-update homepage metrics" \
            -m "ìš´ì˜ ì¼ìˆ˜: ${{ steps.uptime.outputs.days }}ì¼" \
            -m "ì „ì²´ Pod: ${{ steps.cluster.outputs.pods }}ê°œ" \
            -m "ë…¸ë“œ: ${{ steps.cluster.outputs.nodes }}ê°œ" \
            -m "blog-system Pod: ${{ steps.cluster.outputs.blog_pods }}ê°œ" \
            -m "" \
            -m "Co-Authored-By: GitHub Actions Bot <github-actions[bot]@users.noreply.github.com>"

          git push origin main

          echo "ğŸš€ ìë™ ë°°í¬ íŠ¸ë¦¬ê±°ë¨ (deploy-web.yml ì‹¤í–‰ ì˜ˆì •)"

      - name: Summary
        run: |
          echo "### ğŸ“Š ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ìš´ì˜ ì¼ìˆ˜**: ${{ steps.uptime.outputs.days }}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ì „ì²´ Pod**: ${{ steps.cluster.outputs.pods }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë…¸ë“œ**: ${{ steps.cluster.outputs.nodes }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **blog-system Pod**: ${{ steps.cluster.outputs.blog_pods }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… config.toml ìë™ ì—…ë°ì´íŠ¸ ë° ë°°í¬ íŠ¸ë¦¬ê±°" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœ)" >> $GITHUB_STEP_SUMMARY
          fi
