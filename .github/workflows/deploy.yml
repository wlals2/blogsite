name: Deploy Hugo Blog (self-hosted)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€

concurrency:
  group: hugo-deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      
      - name: Build (production)
        env:
          HUGO_ENV: production
          PRIVATE_TOTP_SECRET: ${{ secrets.PRIVATE_TOTP_SECRET }}
          PRIVATE_AES_KEY: ${{ secrets.PRIVATE_AES_KEY }}
        run: |
          set -euxo pipefail
          hugo --minify
          echo "== built files sample =="
          find public -maxdepth 2 -type f | head
          echo "html_count=$(find public -name '*.html' | wc -l)"

      - name: Encrypt private content
        env:
          PRIVATE_AES_KEY: ${{ secrets.PRIVATE_AES_KEY }}
        run: |
          if [ -d "public/private" ]; then
            echo "ğŸ” Encrypting private content..."
            ./scripts/encrypt-private-content.sh
          else
            echo "â„¹ï¸ No private content to encrypt"
          fi
      
      # ë°°í¬ í‘œì‹ì€ 'ë³µì‚¬ ì „ì—' ë§Œë“¤ì–´ì•¼ ì„œë²„ì— ì˜¬ë¼ê°
      - name: Stamp deploy info
        run: |
          printf "source=ci\ntime=%s\ncommit=%s\nrun_id=%s\n" \
            "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "${GITHUB_SHA::7}" "$GITHUB_RUN_ID" \
            > public/deploy.txt
      
      # ========== ë””ë²„ê¹… ë‹¨ê³„ ì¶”ê°€ ==========
      - name: Pre-deployment Debug
        run: |
          echo "====== 1. í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ ======"
          pwd
          
          echo "====== 2. public/ ë””ë ‰í† ë¦¬ í™•ì¸ ======"
          ls -lah public/ | head -15
          
          echo "====== 3. deploy.txt ë‚´ìš© í™•ì¸ ======"
          cat public/deploy.txt
          
          echo "====== 4. index.html ì¡´ì¬ í™•ì¸ ======"
          if [ -f public/index.html ]; then
            echo "âœ… index.html exists"
            wc -l public/index.html
          else
            echo "âŒ index.html NOT found!"
          fi
          
          echo "====== 5. í˜„ì¬ /var/www/blog ìƒíƒœ (ë°°í¬ ì „) ======"
          ls -lah /var/www/blog/ | head -10 || echo "ë””ë ‰í† ë¦¬ ì—†ìŒ"
          
          echo "====== 6. í˜„ì¬ /var/www/blog/deploy.txt (ë°°í¬ ì „) ======"
          cat /var/www/blog/deploy.txt 2>/dev/null || echo "íŒŒì¼ ì—†ìŒ"
      
      - name: Deploy to nginx root (local copy)
        run: |
          set -euxo pipefail
          
          echo "====== ë°°í¬ ì‹œì‘ ======"
          sudo mkdir -p /var/www/blog
          
          echo "====== rsync ì‹¤í–‰ ======"
          sudo rsync -avh --delete public/ /var/www/blog/
          
          echo "====== ê¶Œí•œ ì„¤ì • ======"
          sudo chown -R www-data:www-data /var/www/blog
          sudo chmod -R 755 /var/www/blog
          sudo find /var/www/blog -type f -exec chmod 644 {} \;
          
          echo "====== ë°°í¬ í›„ /var/www/blog ìƒíƒœ ======"
          ls -lah /var/www/blog | head -15
          
          echo "====== ë°°í¬ í›„ deploy.txt ë‚´ìš© ======"
          cat /var/www/blog/deploy.txt
          
          echo "====== nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ======"
          sudo nginx -t
          
          echo "====== nginx ì¬ì‹œì‘ ======"
          sudo systemctl reload nginx
          
          echo "====== nginx ìƒíƒœ í™•ì¸ ======"
          sudo systemctl status nginx --no-pager -l
      
      # ========== ë°°í¬ í›„ ê²€ì¦ ==========
      - name: Post-deployment Verification
        run: |
          echo "====== 1. íŒŒì¼ ê¶Œí•œ í™•ì¸ ======"
          ls -la /var/www/blog/ | head -10
          
          echo "====== 2. ì£¼ìš” íŒŒì¼ ì¡´ì¬ í™•ì¸ ======"
          for file in index.html 404.html index.xml; do
            if [ -f "/var/www/blog/$file" ]; then
              echo "âœ… $file exists ($(wc -c < /var/www/blog/$file) bytes)"
            else
              echo "âŒ $file NOT found"
            fi
          done
          
          echo "====== 3. Nginx access log (ìµœê·¼ 5ì¤„) ======"
          sudo tail -5 /var/log/nginx/access.log || echo "ë¡œê·¸ ì—†ìŒ"
          
          echo "====== 4. Nginx error log (ìµœê·¼ 5ì¤„) ======"
          sudo tail -5 /var/log/nginx/error.log || echo "ì—ëŸ¬ ì—†ìŒ"
          
          echo "====== 5. ë¡œì»¬ curl í…ŒìŠ¤íŠ¸ (HTTP) ======"
          curl -sI http://localhost/ | head -5 || echo "ë¡œì»¬ HTTP ì ‘ì† ì‹¤íŒ¨"
          
          echo "====== 6. ë¡œì»¬ curl í…ŒìŠ¤íŠ¸ (HTTPS) ======"
          curl -skI https://localhost/ -H "Host: blog.jiminhome.shop" | head -5 || echo "ë¡œì»¬ HTTPS ì ‘ì† ì‹¤íŒ¨"
          
          echo "====== 7. ì‹¤ì œ ë„ë©”ì¸ ì ‘ì† í…ŒìŠ¤íŠ¸ ======"
          sleep 2
          curl -sI https://blog.jiminhome.shop/ | head -10 || echo "ë„ë©”ì¸ ì ‘ì† ì‹¤íŒ¨"
          
          echo "====== 8. deploy.txt ì›ê²© ì ‘ì† í…ŒìŠ¤íŠ¸ ======"
          curl -s https://blog.jiminhome.shop/deploy.txt || echo "deploy.txt ì ‘ì† ì‹¤íŒ¨"
          
          echo "âœ… ê²€ì¦ ì™„ë£Œ"
