name: Deploy Hugo Blog (self-hosted)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"

concurrency:
  group: hugo-deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          hugo --minify
          echo "== built files =="
          find public -maxdepth 2 -type f | head

      - name: Deploy to nginx root (local copy)
        run: |
          rm -rf /home/jimin/blogsite/public/*
          cp -a public/* /home/jimin/blogsite/public/
          sudo systemctl reload nginx

