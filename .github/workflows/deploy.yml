name: Deploy Hugo Blog (self-hosted)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"

concurrency:
  group: hugo-deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          hugo --minify
          echo "== built files =="
          find public -maxdepth 2 -type f | head


      - name: Deploy to nginx root (local copy)
        run: |
	    rm -rf /var/www/blog/*
	    rsync -a --delete public/ /var/www/blog/
	    ls -l /var/www/blog | head   # 확인용 로그
	    sudo systemctl reload nginx
      
      - name: Stamp deploy info
        run: |
	    printf "source=ci\ntime=%s\ncommit=%s\n" \
    	      "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "${GITHUB_SHA::7}" > public/deploy.txt

