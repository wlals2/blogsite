name: Deploy Hugo Blog (SSH)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"
  workflow_dispatch: {}     # 수동 실행 버튼

concurrency:
  group: hugo-deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: hugo --minify

      - name: Prepare SSH
        run: |
          install -m 600 /dev/null ~/.ssh/id_deploy
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_deploy
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Publish to /home/jimin/blogsite/public
        run: |
          RSYNC_SSH="ssh -i ~/.ssh/id_deploy -p ${{ secrets.SSH_PORT }}"
          # 목적지 폴더 보장
          $RSYNC_SSH ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /home/jimin/blogsite/public"
          rsync -avz --delete -e "$RSYNC_SSH" public/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/jimin/blogsite/public/

      - name: Nginx health check & reload
        run: |
          ssh -i ~/.ssh/id_deploy -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo nginx -t && sudo systemctl reload nginx || true"

