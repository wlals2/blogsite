name: Deploy Hugo Blog (self-hosted)

on:
  push:
    branches: [ "main" ]
    paths:
      - "content/**"
      - "static/**"
      - "themes/**"
      - "layouts/**"
      - "config.*"
      - "hugo.*"

concurrency:
  group: hugo-deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          set -euxo pipefail
          hugo --minify
          echo "== built files sample =="
          find public -maxdepth 2 -type f | head
          echo "html_count=$(find public -name '*.html' | wc -l)"

      # 배포 표식은 '복사 전에' 만들어야 서버에 올라감
      - name: Stamp deploy info
        run: |
          printf "source=ci\ntime=%s\ncommit=%s\nrun_id=%s\n" \
            "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "${GITHUB_SHA::7}" "$GITHUB_RUN_ID" \
            > public/deploy.txt

      - name: Deploy to nginx root (local copy)
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/www/blog
          sudo chown -R jimin:www-data /var/www/blog
          rsync -ah --delete public/ /var/www/blog/
          ls -l /var/www/blog | head
          sudo nginx -t
          sudo systemctl reload nginx

