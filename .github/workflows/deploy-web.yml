name: Deploy WEB to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  IMAGE_NAME: ghcr.io/wlals2/blog-web
  NAMESPACE: blog-system
  DEPLOYMENT_NAME: web

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ======================================================================
      # Step 1: Checkout ì½”ë“œ
      # ======================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false  # PaperModì€ ë” ì´ìƒ submoduleì´ ì•„ë‹˜

      # ======================================================================
      # Step 2: Docker Buildx ì„¤ì • (ìºì‹œ í™œìš©)
      # ======================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================================================
      # Step 3: GHCR ë¡œê·¸ì¸
      # ======================================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ======================================================================
      # Step 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ======================================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================================================================
      # Step 4.5: ë¹Œë“œ ê²€ì¦
      # ======================================================================
      - name: Verify Build
        run: |
          echo "ğŸ” Verifying Docker image..."

          # 1. ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          docker pull ${{ env.IMAGE_NAME }}:v${{ github.run_number }}

          # 2. ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
          IMAGE_SIZE=$(docker image inspect ${{ env.IMAGE_NAME }}:v${{ github.run_number }} \
            --format='{{.Size}}' | awk '{print int($1/1024/1024)}')
          echo "ğŸ“¦ Image size: ${IMAGE_SIZE} MB"

          # 3. ì´ë¯¸ì§€ í¬ê¸° ê²€ì¦ (10MB ~ 200MB ì‚¬ì´)
          if [ $IMAGE_SIZE -lt 10 ]; then
            echo "âŒ Image too small: ${IMAGE_SIZE} MB (minimum: 10 MB)"
            exit 1
          fi

          if [ $IMAGE_SIZE -gt 200 ]; then
            echo "âš ï¸  Warning: Image is large: ${IMAGE_SIZE} MB (recommended: < 200 MB)"
          fi

          # 4. ë ˆì´ì–´ ìˆ˜ í™•ì¸
          LAYER_COUNT=$(docker image inspect ${{ env.IMAGE_NAME }}:v${{ github.run_number }} \
            --format='{{len .RootFS.Layers}}')
          echo "ğŸ“š Layers: ${LAYER_COUNT}"

          echo "âœ… Build verification passed"

      # ======================================================================
      # Step 5: GitOps - Update Kubernetes Manifest
      # ======================================================================
      # Git Manifestë¥¼ ì—…ë°ì´íŠ¸í•˜ë©´ ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬
      - name: Update Kubernetes Manifest (GitOps)
        env:
          GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          # 1. k8s-manifests repo clone
          git clone https://github.com/wlals2/k8s-manifests.git /tmp/k8s-manifests
          cd /tmp/k8s-manifests/blog-system

          # 2. yqë¡œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          yq eval ".spec.template.spec.containers[0].image = \"${{ env.IMAGE_NAME }}:v${{ github.run_number }}\"" \
            -i web-rollout.yaml

          # 3. Git Commit & Push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add web-rollout.yaml
          git commit -m "chore: Update WEB image to v${{ github.run_number }}"

          # GitHub Tokenìœ¼ë¡œ Push
          git push https://${{ secrets.GHCR_TOKEN }}@github.com/wlals2/k8s-manifests.git main

          echo "âœ… Manifest updated: v${{ github.run_number }}"
          echo "ArgoCD will deploy automatically (within 3min)"

      # ======================================================================
      # Step 6: Wait for ArgoCD Sync
      # ======================================================================
      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30  # ArgoCDëŠ” 3ì´ˆë§ˆë‹¤ poll, ì—¬ìœ ìˆê²Œ 30ì´ˆ ëŒ€ê¸°

          # ArgoCD Application ìƒíƒœ í™•ì¸
          kubectl get application blog-system -n argocd

          # Pod ìƒíƒœ í™•ì¸
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=web

      # ======================================================================
      # Step 7: Cloudflare ìºì‹œ í¼ì§€
      # ======================================================================
      - name: Purge Cloudflare Cache
        if: success()
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
          echo "Cloudflare cache purged successfully"

      # ======================================================================
      # Step 8: ë¹Œë“œ ì •ë³´ ì¶œë ¥
      # ======================================================================
      - name: Build Summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}:v${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ${{ env.DEPLOYMENT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://blog.jiminhome.shop/" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloudflare Cache**: Purged âœ…" >> $GITHUB_STEP_SUMMARY

      # ======================================================================
      # Step 9: ì´ë©”ì¼ ì•Œë¦¼
      # ======================================================================
      - name: Send Email Notification
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì•Œë¦¼
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: |
            ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} WEB ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }} - v${{ github.run_number }}
          to: fw4568@gmail.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ## ${{ job.status == 'success' && 'âœ… ë°°í¬ ì„±ê³µ' || 'âŒ ë°°í¬ ì‹¤íŒ¨' }}

            **ì´ë¯¸ì§€**: ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
            **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            **ì‘ì„±ì**: ${{ github.event.head_commit.author.name }}
            **ì‹œê°„**: ${{ github.event.head_commit.timestamp }}

            **URL**: https://blog.jiminhome.shop/
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ${{ job.status == 'success' && 'ArgoCDê°€ 3ë¶„ ë‚´ ìë™ ë°°í¬í•©ë‹ˆë‹¤.' || 'ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
