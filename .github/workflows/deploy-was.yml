name: Deploy WAS to Kubernetes

# ==============================================================================
# íŠ¸ë¦¬ê±° ì •ì±…
# ==============================================================================
# - push: WAS ì†ŒìŠ¤ ë³€ê²½ ì‹œ ì¦‰ì‹œ CI ì‹¤í–‰
# - schedule: ë§¤ì¼ ìƒˆë²½ 02:00 Trivy CVE ì „ì²´ ìŠ¤ìº” (ë¹Œë“œ ì‹œê°„ ì˜í–¥ ì—†ìŒ)
# - workflow_dispatch: ìˆ˜ë™ ì‹¤í–‰ (ê¸´ê¸‰ ë°°í¬ ë˜ëŠ” ì¬ìŠ¤ìº”)
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'blog-k8s-project/was/**'
      - '.github/workflows/deploy-was.yml'
  # Why: Trivyë¥¼ ì•¼ê°„ ë³„ë„ Jobìœ¼ë¡œ ë¶„ë¦¬ â†’ Push ë¹Œë“œ ì‹œê°„ì— ì˜í–¥ ì—†ìŒ
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 02:00 (KST 11:00)

env:
  IMAGE_NAME: ghcr.io/wlals2/board-was
  NAMESPACE: blog-system
  DEPLOYMENT_NAME: was
  # Why: OWASP DCì˜ NVD CVE DB ìºì‹œ ê²½ë¡œ í†µì¼ â†’ ë§¤ë²ˆ ë‹¤ìš´ë¡œë“œ ë°©ì§€
  NVD_CACHE_DIR: ~/.m2/nvd-cache

# ==============================================================================
# Job êµ¬ì¡° (ë³‘ë ¬ + ìµœì í™” ì „ëµ)
# ==============================================================================
#
# git push â†’ main
#   â”œâ”€[ë³‘ë ¬] secrets-scan   ~30ì´ˆ   GitLeaks Secrets íƒì§€
#   â”œâ”€[ë³‘ë ¬] test            ~30-60ì´ˆ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Maven ìºì‹±)
#   â”œâ”€[ë³‘ë ¬] sca             ~1-2ë¶„  OWASP ì˜ì¡´ì„± CVE ìŠ¤ìº” (NVD ìºì‹±)
#   â””â”€[ë³‘ë ¬] build-push      ~1-2ë¶„  Docker Build + Push (ë ˆì´ì–´ ìºì‹±)
#           â”‚
#           â””â”€(4ê°œ Job ëª¨ë‘ ì„±ê³µ ì‹œ) deploy  ~1ë¶„
#
# schedule (ë§¤ì¼ 02:00):
#   â””â”€ trivy-nightly  ì´ë¯¸ì§€ CVE ì „ì²´ ìŠ¤ìº” â†’ Discord ì•Œë¦¼
#
# ì´ Push CI ì‹œê°„: max(30ì´ˆ, 1ë¶„, 2ë¶„, 2ë¶„) + 1ë¶„ â‰ˆ 2-3ë¶„
# ìºì‹± ì ìš© í›„: max(30ì´ˆ, 30ì´ˆ, 1ë¶„, 1ë¶„) + 1ë¶„ â‰ˆ 2ë¶„
jobs:

  # ============================================================================
  # Job 1: Secrets ìŠ¤ìº” (ë³‘ë ¬)
  # ============================================================================
  # Why: Secretsê°€ GitHubì— pushë˜ê¸° ì „ì— ì°¨ë‹¨í•˜ëŠ” ê²ƒì´ í•µì‹¬
  #      GitLeaksëŠ” Git íˆìŠ¤í† ë¦¬ ì „ì²´ì—ì„œ API í‚¤, ë¹„ë°€ë²ˆí˜¸, í† í° íŒ¨í„´ íƒì§€
  #      íƒì§€ ì˜ˆì‹œ: DISCORD_TOKEN, DB_PASSWORD, AWS_ACCESS_KEY í•˜ë“œì½”ë”©
  secrets-scan:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Why: ì „ì²´ Git íˆìŠ¤í† ë¦¬ ìŠ¤ìº” (ê¸°ë³¸ê°’ depth=1ì´ë©´ ê³¼ê±° ì»¤ë°‹ ë†“ì¹¨)
          fetch-depth: 0

      - name: Scan for secrets with GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Why: Public repoëŠ” ë¼ì´ì„ ìŠ¤ ì—†ì–´ë„ ë™ì‘ (GITLEAKS_LICENSE ë¶ˆí•„ìš”)
          GITLEAKS_ENABLE_SUMMARY: true

  # ============================================================================
  # Job 2: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬)
  # ============================================================================
  # Why: Docker ë¹Œë“œì™€ ë³‘ë ¬ ì‹¤í–‰ â†’ ì „ì²´ CI ì‹œê°„ ë‹¨ì¶•
  #      H2 In-Memory DB â†’ MySQL ì—†ì´ CI í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
  test:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Why: pom.xmlì´ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©´ ìºì‹œì—ì„œ ì˜ì¡´ì„± ë¡œë“œ â†’ ë‹¤ìš´ë¡œë“œ ìƒëµ
      #      íš¨ê³¼: Maven ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ 2-3ë¶„ â†’ 0ì´ˆ (ìºì‹œ íˆíŠ¸ ì‹œ)
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('blog-k8s-project/was/pom.xml') }}
          restore-keys: |
            maven-

      - name: Run Unit Tests (H2 In-Memory DB)
        working-directory: ./blog-k8s-project/was
        run: |
          ./mvnw test -Dspring.profiles.active=test \
            --no-transfer-progress \
            -q

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: blog-k8s-project/was/target/surefire-reports/
          retention-days: 7

  # ============================================================================
  # Job 3: SCA - ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº” (ë³‘ë ¬)
  # ============================================================================
  # Why: TrivyëŠ” ì´ë¯¸ì§€ ë ˆë²¨(OS íŒ¨í‚¤ì§€), OWASP DCëŠ” ì†ŒìŠ¤ ì˜ì¡´ì„± ë ˆë²¨ â†’ ë³´ì™„ ê´€ê³„
  #      pom.xmlì˜ rome, springdoc, mysql-connector ë“±ì˜ CVE íƒì§€
  #      NVD DB ìºì‹±ìœ¼ë¡œ ì²« ì‹¤í–‰ ì´í›„ ì†ë„ ëŒ€í­ ë‹¨ì¶•
  sca:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('blog-k8s-project/was/pom.xml') }}
          restore-keys: |
            maven-

      # Why: NVD CVE DBëŠ” ~500MB, ë§¤ë²ˆ ë‹¤ìš´ë¡œë“œ ì‹œ 1-2ë¶„ ì†Œìš”
      #      ìºì‹±í•˜ë©´ ë‹¤ìŒ ì‹¤í–‰ë¶€í„° ìˆ˜ì´ˆë¡œ ë‹¨ì¶•
      - name: Cache NVD CVE Database
        uses: actions/cache@v4
        with:
          path: ${{ env.NVD_CACHE_DIR }}
          key: nvd-${{ github.run_number }}
          restore-keys: |
            nvd-

      - name: Run OWASP Dependency Check
        working-directory: ./blog-k8s-project/was
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -DdataDirectory=${{ env.NVD_CACHE_DIR }} \
            --no-transfer-progress \
            -q
        # Why: SCAëŠ” ê²½ê³  ëª©ì  (ë¹Œë“œ ì°¨ë‹¨ ì‹œ false positiveë¡œ ë°°í¬ ë§‰í ìˆ˜ ìˆìŒ)
        #      pom.xml failBuildOnCVSS=7 ì„¤ì •ì€ HIGH+ ë°œê²¬ ì‹œ exit-code 1 ë°˜í™˜
        continue-on-error: true

      - name: Upload OWASP DC Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dc-report
          path: blog-k8s-project/was/target/dependency-check/
          retention-days: 14

  # ============================================================================
  # Job 4: Docker ë¹Œë“œ & í‘¸ì‹œ (ë³‘ë ¬)
  # ============================================================================
  # Why: í…ŒìŠ¤íŠ¸/ìŠ¤ìº”ê³¼ ë³‘ë ¬ë¡œ ì‹¤í–‰ â†’ ì „ì²´ CI ì‹œê°„ ë‹¨ì¶•
  build-push:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./blog-k8s-project/was
          file: ./blog-k8s-project/was/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest
          # Why: GitHub Actions ìºì‹œë¡œ Docker ë ˆì´ì–´ ì¬ì‚¬ìš©
          #      Dockerfileì˜ dependency:go-offline ë ˆì´ì–´ê°€ ìºì‹œ â†’ ë¹Œë“œ ë‹¨ì¶•
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Build
        run: |
          docker pull ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
          IMAGE_SIZE=$(docker image inspect ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }} \
            --format='{{.Size}}' | awk '{print int($1/1024/1024)}')
          echo "Image size: ${IMAGE_SIZE} MB"
          if [ $IMAGE_SIZE -lt 50 ]; then
            echo "Image too small: ${IMAGE_SIZE} MB"
            exit 1
          fi

  # ============================================================================
  # Job 5: GitOps ë°°í¬ (ì§ë ¬ - 4ê°œ Job ëª¨ë‘ ì„±ê³µ ì‹œ)
  # ============================================================================
  deploy:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    # Why: secrets, í…ŒìŠ¤íŠ¸, SCA, ë¹Œë“œ ëª¨ë‘ í†µê³¼í•´ì•¼ ë°°í¬ (4ì¤‘ ì•ˆì „ ê²Œì´íŠ¸)
    needs: [secrets-scan, test, sca, build-push]
    steps:
      - name: Update Kubernetes Manifest (GitOps)
        env:
          GITHUB_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          TEMP_DIR="/tmp/k8s-manifests-${{ github.run_number }}"
          git clone https://${{ secrets.GITOPS_TOKEN }}@github.com/wlals2/k8s-manifests.git $TEMP_DIR
          cd $TEMP_DIR/services/blog-system/was

          yq eval ".spec.template.spec.containers[0].image = \"${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}\"" \
            -i was-rollout.yaml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add was-rollout.yaml
          git commit -m "chore: Update WAS image to ${{ needs.build-push.outputs.image-tag }} (Canary)"
          git push origin main

          rm -rf $TEMP_DIR
          echo "Manifest updated: ${{ needs.build-push.outputs.image-tag }}"
          echo "ArgoCD will deploy automatically (within 3min)"

      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30
          kubectl get application blog-system -n argocd
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=was

      - name: Build Summary
        if: success()
        run: |
          echo "### âœ… WAS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Gates**: Secrets âœ… | Tests âœ… | SCA âœ… | Build âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Discord Notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "WAS ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          description: |
            **ì´ë¯¸ì§€**: ${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}
            **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            **ì‘ì„±ì**: ${{ github.event.head_commit.author.name }}
            **ë³´ì•ˆ ê²Œì´íŠ¸**: Secrets âœ… | Tests âœ… | SCA âœ… | Build âœ…
            **URL**: https://blog.jiminhome.shop/
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: ${{ job.status == 'success' && 0x00FF00 || 0xFF0000 }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  # ============================================================================
  # Job 6: ì•¼ê°„ Trivy CVE ìŠ¤ìº” (schedule ì „ìš©)
  # ============================================================================
  # Why: Push ë¹Œë“œ ì‹œê°„ ì˜í–¥ ì—†ì´ CVE ìµœì‹  ì •ë³´ë¡œ ë§¤ì¼ ìŠ¤ìº”
  #      ë§¤ì¼ ìƒˆë²½ ìƒˆë¡œìš´ CVEê°€ ë°œí‘œë˜ë¯€ë¡œ ì •ê¸° ìŠ¤ìº” í•„ìˆ˜
  trivy-nightly:
    if: github.event_name == 'schedule'
    runs-on: self-hosted
    steps:
      - name: Scan latest image with Trivy
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          timeout: '10m'
        continue-on-error: true

      - name: Send Trivy Scan Result to Discord
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ steps.trivy.outcome == 'success' && 'success' || 'failure' }}
          title: "ğŸ”’ ì•¼ê°„ ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ (WAS)"
          description: |
            **ìŠ¤ìº” ëŒ€ìƒ**: ${{ env.IMAGE_NAME }}:latest
            **ìŠ¤ìº” ë²”ìœ„**: CRITICAL, HIGH CVE
            **ê²°ê³¼**: ${{ steps.trivy.outcome == 'success' && 'âœ… ì·¨ì•½ì  ì—†ìŒ' || 'âš ï¸ ì·¨ì•½ì  ë°œê²¬ - í™•ì¸ í•„ìš”' }}
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: ${{ steps.trivy.outcome == 'success' && 0x00FF00 || 0xFF6600 }}
          username: Trivy Scanner
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
