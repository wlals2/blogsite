name: Deploy WAS to Kubernetes

on:
  workflow_dispatch:  # 수동 실행 (WAS 코드는 Git에 포함 안 됨)
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-was.yml'  # 워크플로우 파일 변경 시만

env:
  IMAGE_NAME: ghcr.io/wlals2/board-was
  NAMESPACE: blog-system
  DEPLOYMENT_NAME: was

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ======================================================================
      # Step 1: Checkout 코드
      # ======================================================================
      # Note: WAS 코드는 로컬에만 존재 (.gitignore)
      # Self-hosted runner가 로컬 파일에 직접 접근
      - name: Checkout code
        uses: actions/checkout@v4

      # ======================================================================
      # Step 2: Copy WAS source from local
      # ======================================================================
      # WAS 소스는 Git에 없으므로 로컬에서 복사
      - name: Copy WAS source code
        run: |
          cp -r ~/blogsite/blog-k8s-project/was ./blog-k8s-project/
          ls -la ./blog-k8s-project/was/

      # ======================================================================
      # Step 3: Docker Buildx 설정
      # ======================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================================================
      # Step 4: GHCR 로그인
      # ======================================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ======================================================================
      # Step 5: Docker 이미지 빌드 및 푸시
      # ======================================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./blog-k8s-project/was
          file: ./blog-k8s-project/was/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================================================================
      # Step 6: GitOps - Update Kubernetes Manifest
      # ======================================================================
      # Git Manifest를 업데이트하면 ArgoCD가 자동으로 배포
      - name: Update Kubernetes Manifest (GitOps)
        env:
          GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          # 1. k8s-manifests repo clone
          git clone https://github.com/wlals2/k8s-manifests.git /tmp/k8s-manifests
          cd /tmp/k8s-manifests/blog-system

          # 2. yq로 이미지 태그 업데이트
          yq eval ".spec.template.spec.containers[0].image = \"${{ env.IMAGE_NAME }}:v${{ github.run_number }}\"" \
            -i was-deployment.yaml

          # 3. Git Commit & Push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add was-deployment.yaml
          git commit -m "chore: Update WAS image to v${{ github.run_number }}"

          # GitHub Token으로 Push
          git push https://${{ secrets.GHCR_TOKEN }}@github.com/wlals2/k8s-manifests.git main

          echo "✅ Manifest updated: v${{ github.run_number }}"
          echo "ArgoCD will deploy automatically (within 3min)"

      # ======================================================================
      # Step 7: Wait for ArgoCD Sync
      # ======================================================================
      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30  # ArgoCD는 3초마다 poll, 여유있게 30초 대기

          # ArgoCD Application 상태 확인
          kubectl get application blog-system -n argocd

          # Pod 상태 확인
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=was

      # ======================================================================
      # Step 8: 빌드 정보 출력
      # ======================================================================
      - name: Build Summary
        if: success()
        run: |
          echo "### ✅ WAS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}:v${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ${{ env.DEPLOYMENT_NAME }}" >> $GITHUB_STEP_SUMMARY
