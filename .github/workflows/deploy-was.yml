name: Deploy WAS to Kubernetes

# ==============================================================================
# íŠ¸ë¦¬ê±° ì •ì±…
# ==============================================================================
# - push: WAS ì†ŒìŠ¤ ë³€ê²½ ì‹œ ì¦‰ì‹œ CI ì‹¤í–‰ (test + build-push ë³‘ë ¬)
# - schedule: ë§¤ì¼ ìƒˆë²½ 02:00 Trivy CVE ì „ì²´ ìŠ¤ìº” (ë¹Œë“œ ì‹œê°„ ì˜í–¥ ì—†ìŒ)
# - workflow_dispatch: ìˆ˜ë™ ì‹¤í–‰ (ê¸´ê¸‰ ë°°í¬ ë˜ëŠ” ì¬ìŠ¤ìº”)
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'blog-k8s-project/was/**'
      - '.github/workflows/deploy-was.yml'
  # Why: Trivyë¥¼ ì•¼ê°„ ë³„ë„ Jobìœ¼ë¡œ ë¶„ë¦¬ â†’ ë¹Œë“œ ì‹œê°„ì— ì˜í–¥ ì—†ìŒ
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 02:00 (KST 11:00)

env:
  IMAGE_NAME: ghcr.io/wlals2/board-was
  NAMESPACE: blog-system
  DEPLOYMENT_NAME: was

# ==============================================================================
# Job êµ¬ì¡° (ë³‘ë ¬í™” ì „ëµ)
# ==============================================================================
# git push â†’ main
#   â”œâ”€ [test]        ë³‘ë ¬: H2 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (~1ë¶„)
#   â””â”€ [build-push]  ë³‘ë ¬: Docker Build + Push (~2-3ë¶„)
#         â””â”€ [deploy] ì§ë ¬: GitOps + ArgoCD (test + build-push ëª¨ë‘ ì„±ê³µ ì‹œ)
#
# schedule (ë§¤ì¼ 02:00):
#   â””â”€ [trivy-nightly]  CVE ì „ì²´ ìŠ¤ìº” â†’ Discord ì•Œë¦¼ (~3-5ë¶„)
#
# ì´ CI ì‹œê°„: max(1ë¶„, 2-3ë¶„) + 1ë¶„ â‰ˆ 3-4ë¶„ (ê¸°ì¡´ 5-8ë¶„ ëŒ€ë¹„ ì ˆê°)
jobs:

  # ============================================================================
  # Job 1: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬)
  # ============================================================================
  # Why: Docker ë¹Œë“œì™€ ë³‘ë ¬ë¡œ ì‹¤í–‰ â†’ ì „ì²´ CI ì‹œê°„ ë‹¨ì¶•
  #      H2 In-Memory DB ì‚¬ìš© â†’ MySQL ì—†ì´ CI í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
  test:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Unit Tests (H2 In-Memory DB)
        working-directory: ./blog-k8s-project/was
        run: |
          ./mvnw test -Dspring.profiles.active=test \
            --no-transfer-progress \
            -q

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: blog-k8s-project/was/target/surefire-reports/
          retention-days: 7

  # ============================================================================
  # Job 2: Docker ë¹Œë“œ & í‘¸ì‹œ (ë³‘ë ¬)
  # ============================================================================
  # Why: í…ŒìŠ¤íŠ¸ì™€ ë³‘ë ¬ë¡œ ì‹¤í–‰ â†’ ì „ì²´ CI ì‹œê°„ ë‹¨ì¶•
  #      Trivy ìŠ¤ìº” ì œê±° (ì•¼ê°„ Jobìœ¼ë¡œ ë¶„ë¦¬) â†’ ë¹Œë“œ ì‹œê°„ ì ˆê°
  build-push:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./blog-k8s-project/was
          file: ./blog-k8s-project/was/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Build
        run: |
          docker pull ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
          IMAGE_SIZE=$(docker image inspect ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }} \
            --format='{{.Size}}' | awk '{print int($1/1024/1024)}')
          echo "Image size: ${IMAGE_SIZE} MB"
          if [ $IMAGE_SIZE -lt 50 ]; then
            echo "Image too small: ${IMAGE_SIZE} MB"
            exit 1
          fi

  # ============================================================================
  # Job 3: GitOps ë°°í¬ (ì§ë ¬ - test + build-push ëª¨ë‘ ì„±ê³µ ì‹œ)
  # ============================================================================
  deploy:
    if: github.event_name != 'schedule'
    runs-on: self-hosted
    # Why: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ OR ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë°°í¬í•˜ì§€ ì•ŠìŒ (ì•ˆì „ ê²Œì´íŠ¸)
    needs: [test, build-push]
    steps:
      - name: Update Kubernetes Manifest (GitOps)
        env:
          GITHUB_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          TEMP_DIR="/tmp/k8s-manifests-${{ github.run_number }}"
          git clone https://${{ secrets.GITOPS_TOKEN }}@github.com/wlals2/k8s-manifests.git $TEMP_DIR
          cd $TEMP_DIR/services/blog-system/was

          yq eval ".spec.template.spec.containers[0].image = \"${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}\"" \
            -i was-rollout.yaml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add was-rollout.yaml
          git commit -m "chore: Update WAS image to ${{ needs.build-push.outputs.image-tag }} (Canary)"
          git push origin main

          rm -rf $TEMP_DIR
          echo "Manifest updated: ${{ needs.build-push.outputs.image-tag }}"
          echo "ArgoCD will deploy automatically (within 3min)"

      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30
          kubectl get application blog-system -n argocd
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=was

      - name: Build Summary
        if: success()
        run: |
          echo "### âœ… WAS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Discord Notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "WAS ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          description: |
            **ì´ë¯¸ì§€**: ${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image-tag }}
            **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            **ì‘ì„±ì**: ${{ github.event.head_commit.author.name }}
            **URL**: https://blog.jiminhome.shop/
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: ${{ job.status == 'success' && 0x00FF00 || 0xFF0000 }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  # ============================================================================
  # Job 4: ì•¼ê°„ Trivy CVE ìŠ¤ìº” (schedule ì „ìš©)
  # ============================================================================
  # Why: ë¹Œë“œ ì‹œê°„ ì˜í–¥ ì—†ì´ CVE ìµœì‹  ì •ë³´ë¡œ ë§¤ì¼ ìŠ¤ìº”
  #      CRITICAL ë°œê²¬ ì‹œ Discord ì•Œë¦¼ â†’ ì¦‰ì‹œ ëŒ€ì‘ ê°€ëŠ¥
  trivy-nightly:
    if: github.event_name == 'schedule'
    runs-on: self-hosted
    steps:
      - name: Scan latest image with Trivy
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: 'table'
          # Why: ì•¼ê°„ ìŠ¤ìº”ì—ì„œëŠ” CRITICAL ë°œê²¬ ì‹œ ì•Œë¦¼ë§Œ (ë¹Œë“œ ì°¨ë‹¨ ì—†ìŒ)
          #      CRITICAL ì·¨ì•½ì  ë°œê²¬ â†’ Discord ì•Œë¦¼ â†’ ê°œë°œìê°€ ë‹¤ìŒ ë°°í¬ ì‹œ ìˆ˜ì •
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          timeout: '10m'
        continue-on-error: true

      - name: Send Trivy Scan Result to Discord
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ steps.trivy.outcome == 'success' && 'success' || 'failure' }}
          title: "ğŸ”’ ì•¼ê°„ ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ (WAS)"
          description: |
            **ìŠ¤ìº” ëŒ€ìƒ**: ${{ env.IMAGE_NAME }}:latest
            **ìŠ¤ìº” ë²”ìœ„**: CRITICAL, HIGH CVE
            **ê²°ê³¼**: ${{ steps.trivy.outcome == 'success' && 'âœ… ì·¨ì•½ì  ì—†ìŒ' || 'âš ï¸ ì·¨ì•½ì  ë°œê²¬ - í™•ì¸ í•„ìš”' }}
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: ${{ steps.trivy.outcome == 'success' && 0x00FF00 || 0xFF6600 }}
          username: Trivy Scanner
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
