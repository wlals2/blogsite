name: Deploy WAS to Kubernetes

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ (WAS ì½”ë“œëŠ” Gitì— í¬í•¨ ì•ˆ ë¨)
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-was.yml'  # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ ì‹œë§Œ

env:
  IMAGE_NAME: ghcr.io/wlals2/board-was
  NAMESPACE: blog-system
  DEPLOYMENT_NAME: was

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ======================================================================
      # Step 1: Checkout ì½”ë“œ
      # ======================================================================
      # Note: WAS ì†ŒìŠ¤ëŠ” ì´ì œ Gitì— í¬í•¨ (SSOT ì¤€ìˆ˜)
      - name: Checkout code
        uses: actions/checkout@v4

      # ======================================================================
      # Step 2: Docker Buildx ì„¤ì •
      # ======================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================================================
      # Step 4: GHCR ë¡œê·¸ì¸
      # ======================================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ======================================================================
      # Step 5: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ======================================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./blog-k8s-project/was
          file: ./blog-k8s-project/was/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================================================================
      # Step 5.5: ë¹Œë“œ ê²€ì¦
      # ======================================================================
      - name: Verify Build
        run: |
          echo "ğŸ” Verifying Docker image..."

          # 1. ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          docker pull ${{ env.IMAGE_NAME }}:v${{ github.run_number }}

          # 2. ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
          IMAGE_SIZE=$(docker image inspect ${{ env.IMAGE_NAME }}:v${{ github.run_number }} \
            --format='{{.Size}}' | awk '{print int($1/1024/1024)}')
          echo "ğŸ“¦ Image size: ${IMAGE_SIZE} MB"

          # 3. ì´ë¯¸ì§€ í¬ê¸° ê²€ì¦ (WASëŠ” 50MB ~ 500MB)
          if [ $IMAGE_SIZE -lt 50 ]; then
            echo "âŒ Image too small: ${IMAGE_SIZE} MB (minimum: 50 MB)"
            exit 1
          fi

          if [ $IMAGE_SIZE -gt 500 ]; then
            echo "âš ï¸  Warning: Image is large: ${IMAGE_SIZE} MB (recommended: < 500 MB)"
          fi

          # 4. ë ˆì´ì–´ ìˆ˜ í™•ì¸
          LAYER_COUNT=$(docker image inspect ${{ env.IMAGE_NAME }}:v${{ github.run_number }} \
            --format='{{len .RootFS.Layers}}')
          echo "ğŸ“š Layers: ${LAYER_COUNT}"

          echo "âœ… Build verification passed"

      # ======================================================================
      # Step 6: GitOps - Update Kubernetes Manifest (Stateless)
      # ======================================================================
      # Stateless ë°©ì‹: ë§¤ë²ˆ ì„ì‹œ ë””ë ‰í„°ë¦¬ë¡œ cloneí•˜ì—¬ ë¡œì»¬ ì˜ì¡´ì„± ì œê±°
      - name: Update Kubernetes Manifest (GitOps)
        env:
          GITHUB_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          # 1. ì„ì‹œ ë””ë ‰í„°ë¦¬ë¡œ k8s-manifests clone (Stateless)
          TEMP_DIR="/tmp/k8s-manifests-${{ github.run_number }}"
          echo "ğŸ“ Cloning to: $TEMP_DIR"

          git clone https://${{ secrets.GITOPS_TOKEN }}@github.com/wlals2/k8s-manifests.git $TEMP_DIR
          cd $TEMP_DIR/blog-system

          # 2. yqë¡œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (Rollout)
          yq eval ".spec.template.spec.containers[0].image = \"${{ env.IMAGE_NAME }}:v${{ github.run_number }}\"" \
            -i was-rollout.yaml

          # 3. Git Commit & Push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add was-rollout.yaml
          git commit -m "chore: Update WAS image to v${{ github.run_number }} (Canary)"
          git push origin main

          echo "âœ… Manifest updated: v${{ github.run_number }}"
          echo "ArgoCD will deploy automatically (within 3min)"

          # 4. Cleanup (ì„ì‹œ ë””ë ‰í„°ë¦¬ ì‚­ì œ)
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ Cleaned up temporary directory"

      # ======================================================================
      # Step 7: Wait for ArgoCD Sync
      # ======================================================================
      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30  # ArgoCDëŠ” 3ì´ˆë§ˆë‹¤ poll, ì—¬ìœ ìˆê²Œ 30ì´ˆ ëŒ€ê¸°

          # ArgoCD Application ìƒíƒœ í™•ì¸
          kubectl get application blog-system -n argocd

          # Pod ìƒíƒœ í™•ì¸
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=was

      # ======================================================================
      # Step 8: ë¹Œë“œ ì •ë³´ ì¶œë ¥
      # ======================================================================
      - name: Build Summary
        if: success()
        run: |
          echo "### âœ… WAS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}:v${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ${{ env.DEPLOYMENT_NAME }}" >> $GITHUB_STEP_SUMMARY

      # ======================================================================
      # Step 9: ì´ë©”ì¼ ì•Œë¦¼
      # ======================================================================
      - name: Send Email Notification
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì•Œë¦¼
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: |
            ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} WAS ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }} - v${{ github.run_number }}
          to: fw4568@gmail.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ## ${{ job.status == 'success' && 'âœ… ë°°í¬ ì„±ê³µ' || 'âŒ ë°°í¬ ì‹¤íŒ¨' }}

            **ì´ë¯¸ì§€**: ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
            **ì›Œí¬í”Œë¡œìš°**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ${{ job.status == 'success' && 'ArgoCDê°€ 3ë¶„ ë‚´ ìë™ ë°°í¬í•©ë‹ˆë‹¤.' || 'ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
# Trigger: 1768952043
